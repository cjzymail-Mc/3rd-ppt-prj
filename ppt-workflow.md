# PPT 工程化高标准工作流（COM 精准控制版）

> 版本：v2.0（规范化重构）  
> 目标：将 PPT 生产过程升级为可复用、可测试、可迭代的软件工程流水线。  
> 适用范围：本仓库 `Main.py + src/` 体系下的问卷类报告自动化生产。

---

## 1. 文档目标与核心原则

### 1.1 目标
将“高精度 PPT 制作”定义为标准软件交付流程：

**规划 → 构建 → 测试 → 反馈 → 修改（多轮）→ 交付**。

### 1.2 核心原则（强约束）
1. **严格复用现有架构**：必须基于 `Main.py + src/` 进行扩展，禁止推翻式重写。
2. **技术路线固定**：
   - PowerPoint：`pywin32 + win32com.client`（真实 `PowerPoint.Application` COM 接口）
   - Excel：`xlwings + COM API(.api)` 混合控制
3. **硬性禁止**：严禁使用 `python-pptx`。
4. **数据单一来源**：所有业务内容必须来自 Excel 数据源（问卷 Sheet）。
5. **样式保护优先**：优先“复制标准模板页 + 仅替换内容”，不得破坏模板视觉资产。

---

## 2. 输入资产与上下文

### 2.1 核心输入文件
- `Main.py` + `src/`：现有可复用主流程和能力函数。
- `repo-scan-result.md`：现有代码扫描和能力分析结果。
- `Template 2.1.pptx`：模板复合文件，关键页面：
  - 第14页：空白模板页（基线）
  - 第15页：标准模板页（目标效果）
- `2025 数据 v2.2.xlsx`：唯一数据源（重点：`问卷sheet`）。

### 2.2 目标输出物
- 脚本：
  - `01-shape-detail.py`
  - `02-build_ppt_com.py`
  - `03-shape_diff_test.py`
- 中间与报告：
  - `shape_detail_com.json`
  - `shape-detail.md`
  - `fix-ppt.md`
- 成品：
  - `codex 1.0.pptx`（首版）
  - `codex 1.1/1.2/1.3.pptx`（迭代版，不覆盖）

---

## 3. 角色与职责（工程化分工）

1. **架构与规划**：定义实现边界、可复用模块、风险与回滚策略。
2. **开发与构建**：按 shape/功能函数化实现，严格保持模板样式。
3. **测试与验证**：属性级 diff + 人工视觉复核，给出可追溯报告。
4. **反馈与修复**：基于差异定位根因，最小修改闭环修复。
5. **交付与归档**：输出最终版本、差异报告、可复现命令。

---

## 4. 端到端交付流程

## Step 0：基线确认（必须先做）
- 读取并确认：`Main.py`、`src/`、`repo-scan-result.md`、本工作流文档。
- 确认 Office COM 环境可用（Excel 与 PowerPoint 可被自动化启动）。
- 确认模板页码和数据 Sheet 名称未漂移。

**验收标准**：环境可启动 + 路径正确 + 输入文件完整。

---

## Step 1：Shape 差异识别（`01-shape-detail.py`）

### 任务目标
对比 `Template 2.1.pptx`：
- 第14页（空白模板）
- 第15页（标准模板）

识别“标准模板新增 shape”。

### 必采集字段
对每个新增 shape 输出：
- `slide_index`
- `name`（为空时需按特征生成短名，且保持稳定映射）
- `left/top/width/height`
- 字体信息（名称、字号、粗细等）
- `shape.Type`、语义类型（文本/图片/chart）
- 文本内容（如有）
- 分组信息（是否在 Group 内）

### 额外要求
- 字体若在 `src/Class_030.py` 中无对应类，需按现有风格新增。
- 产出 `shape_detail_com.json` + `shape-detail.md`（人可读与机可读双格式）。

**验收标准**：新增 shape 识别完整，字段可用于后续自动定位更新。

---

## Step 2：内容构建与PPT生成（`02-build_ppt_com.py`）

### 2.1 内容构建
- 按新增 shape 数量（例如9个）设计对应函数（建议一 shape 一函数）。
- 所有内容来源于 `2025 数据 v2.2.xlsx` 的 `问卷sheet`。
- 可复用现有 GPT 通讯函数，仅新增 prompt，不重复造轮子。

### 2.2 生成策略（关键）
必须遵循以下顺序：
1. 启动 `PowerPoint.Application(Visible=False)`
2. 新建 Presentation
3. 从 `Template 2.1.pptx` 第15页完整克隆 slide（保留源格式）
4. 按 `shape_detail_com.json` 定位目标 shape
5. **仅替换内容，不改样式骨架**：
   - 文本：更新 `TextFrame.TextRange.Text`
   - 图表：通过 `ChartData` 或 `Series.Values/Categories` 更新数据
   - 图片：按需替换，保持布局与比例
6. 输出 `codex 1.0.pptx`

### 2.3 数据与统计约束
- 仅进行必要统计（均值、频率、汇总等），避免引入重型依赖。
- Excel 读取优先用 `xlwings`，图表细节通过 `.api` 补充控制。

**验收标准**：生成文件可打开，版式与标准模板保持一致，仅内容被替换。

---

## Step 3：差异测试与自动反馈（`03-shape_diff_test.py`）

### 对比对象
- 标准页：`Template 2.1.pptx` 第15页
- 生成页：`codex *.pptx` 第1页

### 对比维度
- 位置：`Left/Top`
- 尺寸：`Width/Height`
- 字体：字体名、字号、样式
- 颜色：文本/填充/线条关键颜色
- 图表：图表类型、系列结构、关键格式

### 输出
- 差异报告（含字段级对比与偏差值）
- `fix-ppt.md`：
  - 差异清单
  - 根因推断
  - 修复建议与优先级

**验收标准**：可复现、可追溯、可直接驱动下一轮修复。

---

## Step 4：多轮迭代修复（最多 N 轮）

### 迭代规则
- 若未达标，执行：**修复代码 → 重生 PPT → 重跑 diff**。
- 每轮版本号递增：`codex 1.1.pptx`、`codex 1.2.pptx`、`codex 1.3.pptx`...
- 禁止覆盖历史版本，保留回溯能力。

### 停止条件
满足任一条件可停止：
1. 自动化差异指标达到目标阈值（建议视觉保真度 ≥98%）。
2. 达到最大迭代轮次（如3轮）并输出风险说明。
3. 用户人工确认“可交付”。

---

## Step 5：人工验收与交付

### 人工验收
用户对“最新生成版 vs 标准模板”进行肉眼复核，重点关注：
- 排版整体一致性
- 字体/间距/对齐细节
- 图表样式一致性
- 局部内容语义准确性

### 交付清单
1. 最终 PPT 文件（最新版本）
2. `shape-detail.md`
3. `fix-ppt.md`
4. 关键执行命令与复现说明

---

## 5. 质量标准（Definition of Done）

满足以下条件才算完成：
1. 技术约束满足：全流程未使用 `python-pptx`。
2. 数据一致：内容全部来自指定 Excel 数据源。
3. 样式保真：模板视觉资产未被破坏，关键属性差异在阈值内。
4. 流程闭环：至少完成一次“构建→测试→反馈→修复”。
5. 文档完整：有差异报告、有修复记录、有可复现命令。

---

## 6. 风险、异常与防护策略

1. **COM 不稳定/应用挂起**
   - 策略：超时、重试、显式释放对象、按顺序关闭应用。
2. **剪贴板冲突**
   - 策略：重试 + 退避等待 + 最小化并发操作。
3. **字体缺失导致排版漂移**
   - 策略：启动前校验字体，必要时补充字体类映射。
4. **模板页码变化**
   - 策略：通过标题/标识二次校验页面语义，避免硬编码失效。
5. **Excel 数据结构变更**
   - 策略：增加关键字段校验和失败早停提示。

---

## 7. 推荐执行命令（示例）

```bash
python 01-shape-detail.py
python 02-build_ppt_com.py
python 03-shape_diff_test.py
```

如需迭代：
```bash
python 02-build_ppt_com.py --version 1.1
python 03-shape_diff_test.py --target "codex 1.1.pptx"
```

---

## 8. 变更控制

- 任何新需求进入前，先评估是否影响：
  - 模板结构
  - 数据源结构
  - 差异阈值
  - 交付周期
- 重大变更需先更新本工作流文档，再进入开发。

---

## 9. 结语

本流程的本质不是“生成一个 PPT 文件”，而是构建一条 **高保真、可验证、可迭代、可交付** 的 PPT 软件工程产线。  
坚持“模板克隆 + 精准替换 + 差异闭环”，才能稳定满足高精度业务要求。
