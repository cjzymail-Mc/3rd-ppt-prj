# PLAN.md — 《问卷模板-1》→《篮球试穿问卷PPT》自动生成（开发计划）

日期：2026-02-09  
负责人角色：Architect（只出计划，不写实现代码）

---

## 0. 本计划的边界与原则

### 0.1 目标（你强调的三件事）
本次新增核心能力只聚焦三部分：

1) **制表**：从 Excel 问卷数据得到可展示的汇总指标与图表（主要是均值/计数）。  
2) **排版**：把图表、图片、文本放进 PPT 模板的**固定区域**，保证像素级稳定。  
3) **文字处理**：把问卷字段拼装成 PPT 可读文案（确定性拼接为主，可选 GPT 润色）。

### 0.2 技术路线（强制复用旧脚本思路）
- PowerPoint：**纯 COM 自动化（win32com）**；不使用 python-pptx 生成版式。
- Excel：**xlwings + .api(COM)**；读写用 xlwings，图表/细节用 COM。
- 传输：优先走你熟练的 **Clipboard Bridge（Copy/Paste）**；同时预留“直接更新 PPT 内嵌 Chart 数据”的稳态方案。
- 排版：坚持 **Pixel-Perfect Layout**（Left/Top/Width/Height + ZOrder）。
- 统计：**不引入 numpy/pandas**；只做 sum/len（或 statistics.mean）级别的轻计算。

---

## 1. 需求拆解（输入/输出/批处理）

### 1.1 输入
- Excel：`问卷模板-1.xlsx`
  - 当前样例 sheet：`篮球鞋试穿反馈`
  - 关键字段（列名以实际 Excel 表头为准）：
    - 试穿鞋款名称
    - 体重
    - 7 项评分：抓地性、缓震性、包裹性、抗扭转性、重量&透气性、防侧翻性、耐久性
    - 你的脚型 / 足弓支撑（有/没有）/ 颜值星级
    - 适合打法（文本）/ 补充说明（长文本）

- PPT 模板：`篮球试穿问卷ppt模板 - 1.pptx`（目前只有 1 页模板页）

### 1.2 输出
- 生成 PPT：`篮球试穿问卷PPT_[鞋款名]_[日期].pptx`（默认一份 Excel 生成 1 个 deck）
- 若一个 Excel 内包含多个鞋款（多行不同“试穿鞋款名称”）：
  - 默认策略：**每个鞋款复制模板页一份**，形成多页 deck
  - 可配置：每个鞋款单独输出一个 deck

### 1.3 批处理
- 输入：一个目录或文件列表（数十份 Excel）
- 输出：逐文件生成 PPT
- 必须产出：`log/` 下的运行日志与指标快照（便于定位失败与回归）

---

## 2. 成果交付物（Developer 落地时必须产出）

1) `PLAN.md`（本文件）  
2) `CODEBASE_ANALYSIS.md`（基于 repo-scan-result.md 的复用点与改动点，Developer 可用你现成扫描结果补齐）  
3) `claude-progress.md`（开发过程记录，便于后续 agent 接力）  
4) 代码侧（由 Developer 实现）：
   - `040 Basketball Survey PPT Robot.py`（新入口脚本，保持你 030 的编排风格）
   - `src/Function_040.py`（本次新功能主逻辑：解析/制表/排版/文字）
   - `src/Global_var_040.py`（模板页映射、锚点、坐标、字段字典）
   - （可选）`src/Class_040.py`（如果需要新增更高层的“模板占位符对象”封装）

---

## 3. 模板锚点方案（排版稳定性的关键决策）

> 你的旧脚本能做到像素级排版，但“找对 shape”是稳定性的生命线。  
> 本计划把模板定位分成 **强推荐方案** + **兼容方案** 两档。

### 3.1 强推荐：占位符锚点（最稳）
在 PPT 模板中，把需要被替换的文字改成唯一占位符（文本可见但不会被误用），例如：

- `{SHOE_NAME}`（鞋名）
- `{OVERALL_SCORE}`（如 8.29/10）
- `{GRADE}`（如 A）
- `{ROUND_NAME}`（如 First round）
- `{SAMPLE_INFO}`（试穿人数/平均体重/定位）
- `{TEXT_BLOCK_1}`（如【包裹性】段落）
- `{TEXT_BLOCK_2}`（如【止滑性】【场地感】段落）
- 版本对比区块：
  - `{VARIANT_A}` `{VARIANT_B}` `{VARIANT_C}`（30C/35C/40C）
  - `{COMPARE_AB}` `{COMPARE_AC}`

**实现方式（COM）**：遍历 slide.Shapes，找到 TextFrame.TextRange.Text 包含占位符的 shape → 替换并保留字体/段落格式（或按 Text_Box 统一重设）。

### 3.2 兼容方案：shape 名称映射（不用改模板但较脆）
若暂时不想动模板：
- 在 `Global_var_040.py` 维护一个 mapping：业务字段 → shape.Name（例如 “矩形 11”、“图表 44” 等）
- 风险：模板编辑后 shape 名称可能变化，需同步更新 mapping。

### 3.3 混合方案（建议）
- 文本：用占位符锚点（高频替换，最需要稳）
- 图表/图片：用 shape.Name 锚点（例如固定 chart 叫 `chart_radar`，图片叫 `img_shoe_hero`）

> 结论：**至少把文本改为占位符**，这是批处理稳定性的投入产出比最高的一步。

---

## 4. 数据解析设计（不复杂，但要“规则化”）

### 4.1 表头字段字典（必须做）
在 `Global_var_040.py` 建立“字段同义词”映射，避免 Excel 表头轻微改动导致崩溃：

- weight：`体重（Weight）` / `体重` / `Weight`
- shoe_name：`试穿鞋款名称` / `鞋款名称`
- scores（7项）：按当前模板表头建立映射
- extra_text：`补充说明`
- play_style：`你认为这双鞋更加适合什么打法的球员穿`

### 4.2 分组策略
- 先按 `shoe_name` 分组（一个文件可能多鞋款）
- 每个鞋款组内 rows = 测试者记录数 N

### 4.3 轻计算指标（MVP）
对每个鞋款组计算：
- `N`：试穿人数
- `avg_weight`：平均体重（保留 1 位小数）
- 7项评分均值（保留 2 位小数）
- `overall_score`：7项均值再取均值（= 所有评分总和 / (7*N)）
- `grade`：按阈值映射（建议）
  - A：>= 8.0
  - B：>= 7.0 且 < 8.0
  - C：< 7.0
  （阈值放配置里，方便调整）

### 4.4 “球场定位”规则（文本→标签）
从 `play_style` 文本提取并汇总：
- 包含“后卫/卫/控/速度型/突投结合” → 计入“卫”
- 包含“锋/前锋/侧翼/3D” → 计入“锋”
- 包含“中锋/内线/篮下” → 计入“中”

输出展示建议：
- 取出现过的集合去重，用“、”连接（示例：锋、卫）
- 若为空：显示“-”

### 4.5 “补充说明”文本处理（不靠复杂 NLP）
目标是生成类似模板的分块段落，并能出现（k/N）的计数形式。

MVP 做法（规则映射 + 计数）：
1) 预定义分类 → 关键词：
   - 包裹性：卡脚、鞋面、鞋带、勒、顶脚背、挤压、磨
   - 稳定性：外翻、内扣、支撑、侧翻、扭转
   - 止滑性：打滑、吸灰、擦、摩擦、吱吱声
   - 缓震/回弹：气垫、回弹、震脚、脚感
   - 场地感：触地、反馈、路感
   - 耐久：耐磨、开胶、橡胶
2) 对每条补充说明按分类命中计数：命中则该分类 k+1（每人最多给该类贡献 1 次，避免一句话多个关键词导致重复加权）
3) 生成“要点句式”：
   - 若某分类有命中：输出 1~3 条代表性原句（可截断），并附（k/N）
   - 若无命中：不输出该分类
4) 形成两个文本块（匹配现模板两个大段落）：
   - TEXT_BLOCK_1：包裹性/稳定性为主
   - TEXT_BLOCK_2：止滑性/场地感/缓震等

> 这套规则完全不需要 pandas/numpy；也不需要复杂统计。后续若你希望更像“报告口吻”，再把“要点列表”交给 GPT 做润色即可（GPT 不负责计数）。

---

## 5. 制表方案（图表生成与落地策略）

### 5.1 雷达图（核心）
模板里已有 `图表 44`（Chart shape）。因此我们有两条路线：

**路线 A（最快复用旧脚本，MVP）**  
- 用 Excel（xlwings）临时生成雷达图/蜘蛛图 → `.api` 清洗格式（隐藏网格/标题等）  
- `.Copy()` → PPT `.Paste()` → 用 Left/Top/Width/Height 定位覆盖模板的图表区域  
- 优点：完全符合你旧脚本“make_chart”风格，落地快  
- 风险：剪贴板偶发不稳定；粘贴对象类型可能变化（图/EMF/Chart）

**路线 B（更稳，建议作为 Phase-2）**  
- 直接找到模板里的 `图表 44`，通过 PPT COM ChartData 更新数据源（不走剪贴板）  
- 优点：批处理稳定、速度更快、版式不漂  
- 风险：需要熟悉 PowerPoint ChartData 的 COM 写法（但这是一次性投入）

**决策建议**：
- Phase-1 先做路线 A（最快交付）
- Phase-2 把路线 B 作为“稳定性升级”里程碑

### 5.2 指标展示（数字、表格）
- 总分、评级、均值：用文本框直接写入（不做表格控件）
- 若需要展示“7项均值表”：可以用 PPT 的 Table（COM）或用文本对齐模拟；优先采用你旧代码里最稳的方式

---

## 6. 排版方案（像素级定位 + 层级）

### 6.1 固定布局策略
- 以模板页为“母版页”
- 每个鞋款：
  1) 复制模板 slide（或复制后插入末尾）
  2) 替换文本占位符
  3) 更新图表（路线 A 或 B）
  4) 更新图片（若有）
  5) 统一 ZOrder（保证线条/背景/图表/图片层级正确）

### 6.2 坐标与尺寸来源
- 第一优先：从模板里读取目标 shape 的位置（Left/Top/Width/Height），作为粘贴对象的定位依据
- 这样避免硬编码坐标到脚本里（模板若微调，只要 shape 仍在，位置自动跟随）

### 6.3 图片策略（如果后续需要放鞋图/测试照片）
- 若图片来自 Excel 复制：复用你现有 `mc_pic` 思路
- 若图片来自文件路径：PPT `Shapes.AddPicture` 后等比缩放，最后对齐到图片占位框

---

## 7. 文字处理方案（格式、溢出、可选 GPT）

### 7.1 文本写入规则（强制）
- 所有写入统一走你已有 `Text_Box` 封装（或等价逻辑）：
  - 字体：微软雅黑/Arial（按模板）
  - 行距：固定值（按模板）
  - 对齐：按模板

### 7.2 溢出控制（批处理必须）
针对长段落（补充说明汇总）：
- 先测量：写入后若超出框（COM 可读 TextRange.BoundHeight/Shape.Height 等指标）
- 溢出策略（按优先级）：
  1) 轻微降低字号（例如 -1/-2）
  2) 降行距
  3) 截断并补 “…”（保底不爆框）
- 所有策略写成可配置常量，便于你后续调风格

### 7.3 GPT 的使用边界（可选）
- GPT 只做“润色/总结”，不做计数与事实判断  
- 输入给 GPT：分类要点列表（带 k/N）  
- 输出：两段成文文本（仍需做溢出控制）  
- 提供开关：`use_gpt = False` 时纯规则文本也能完整生成 PPT

---

## 8. 批处理与稳定性（结合你旧脚本的经验）

### 8.1 运行形态
- 单次启动：创建 1 个 Excel.Application + 1 个 PowerPoint.Application  
- 批量循环：复用应用实例（不要每个文件重启 Office）

### 8.2 剪贴板重试机制（Phase-1 必须）
对 `.Copy()` → `.Paste()`：
- 固定重试次数（例如 3 次）
- 每次失败 sleep（例如 0.3s / 0.6s / 1.0s）
- 失败时写日志并跳过该文件（不中断整个批次）

### 8.3 日志与快照
每份 Excel 输出：
- `output/xxx.pptx`
- `log/xxx.json`：包含 N、avg_weight、7项均值、overall、grade、解析到的定位标签等
- `log/xxx.txt`：包含异常栈与失败步骤（定位用）

---

## 9. 分阶段实施路径（Developer 按顺序做）

### Phase 0（半天）：模板锚点规范化
- 在 PPT 模板中替换成占位符（或重命名关键 shape）
- 输出 `Global_var_040.py` 的占位符/shape 映射清单

**验收**：脚本能稳定定位到所有要替换的 shape（无需生成数据）。

### Phase 1（1~2 天）：单文件 MVP 跑通
- 解析 Excel（分组 + 轻计算）
- 替换文本占位符（鞋名、总分、评级、样本信息、轮次名）
- 生成/更新图表（先走路线 A）
- 保存输出 PPT

**验收**：用样例数据能生成与模板风格一致的 1 页（或多页）PPT。

### Phase 2（1~2 天）：文字块质量 + 溢出控制
- 补充说明 → 分类计数 → 两段文本生成
- 加入溢出控制策略
- （可选）接 GPT 润色开关

**验收**：长文本不会爆框；输出稳定可读。

### Phase 3（1~2 天）：批处理稳定化
- 目录遍历、输出命名、日志快照
- 剪贴板重试、异常不中断
- 资源释放（Quit/Close）

**验收**：连续处理 20 份 Excel 成功率 ≥ 95%，失败可追溯。

### Phase 4（可选优化）：用路线 B 替换雷达图剪贴板
- 更新模板内嵌 ChartData
- 大幅降低批处理不稳定来源

**验收**：关掉剪贴板也能生成正确雷达图；批处理更快更稳。

---

## 10. 风险清单与应对

1) **模板被编辑导致定位失效**  
   - 应对：占位符锚点（强推荐）+ 关键 shape 重命名  
2) **剪贴板偶发失败**  
   - 应对：重试+延时；Phase-4 迁移到内嵌 ChartData  
3) **中文字体在不同电脑渲染差异**  
   - 应对：统一字体、在模板锁定字号/段落；必要时输出前强制设置  
4) **Excel 表头微调导致字段取不到**  
   - 应对：字段同义词字典 + 缺失字段降级（填 “-”）  
5) **补充说明文本噪声大**  
   - 应对：规则分类优先，GPT 只做润色并可关闭

---

## 11. 验收标准（最终 checklist）

- [ ] 不新增 numpy/pandas 依赖
- [ ] 能解析《问卷模板-1》并按鞋款分组生成 PPT（单鞋款/多鞋款都可）
- [ ] 输出指标正确：N、平均体重、7项均值、overall（保留位数符合预期）
- [ ] PPT 排版稳定：元素落在模板区域、层级正确、无明显漂移
- [ ] 长文本不爆框：有降字号/截断保底策略
- [ ] 批处理可跑：目录 20 份以上可稳定输出，失败有日志可追溯

---

## 12. 交接给 Developer 的落地提示

- 保持你现有 `030` 的编排风格（COM Orchestrator + Function 模块 + Class 封装）
- 优先做“占位符锚点”规范化，这是批量稳定的关键
- Phase-1 先跑通路线 A（复制粘贴图表），再决定要不要做路线 B（内嵌 ChartData）
